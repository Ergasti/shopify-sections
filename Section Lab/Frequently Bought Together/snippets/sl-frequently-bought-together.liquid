{% comment %}
  FBT block snippet — use in product info via Custom Liquid block.
  Usage: {% render 'sl-frequently-bought-together', block_id: block.id, product: product %}
  Uses recommendations/products.json (no section_id). Pass product if block context lacks it.
{% endcomment %}

{% assign block_id = block_id | default: 'fbt' %}
{% assign prod = product | default: nil %}
{% assign locale_iso = request.locale.iso_code | default: 'en' %}
{% assign is_rtl = false %}
{% assign locale_start = locale_iso | slice: 0, 2 %}
{% if locale_iso == 'ar' or locale_iso == 'he' or locale_iso == 'fa' or locale_iso == 'ur' or locale_iso == 'yi' %}
  {% assign is_rtl = true %}
{% elsif locale_start == 'ar' %}
  {% assign is_rtl = true %}
{% endif %}

{% if prod == blank %}
  {% if request.design_mode %}
    <p style="padding: 12px; color: #666;">FBT — Use on product page.</p>
  {% endif %}
{% else %}

<div id="sl-fbt-block-{{ block_id }}" class="sl-fbt-block-root{% if is_rtl %} sl-fbt-rtl{% endif %}" data-fbt-fetch data-product-id="{{ prod.id }}"{% if is_rtl %} dir="rtl"{% endif %}>
  <div class="sl-fbt-fetch-placeholder" style="min-height: 180px; display: flex; align-items: center; justify-content: center; color: #666;">{{ 'sections.sl_fbt.loading' | t }}</div>
</div>

<style>
  #sl-fbt-block-{{ block_id }}.sl-fbt-block-root {
    width: 100%;
    margin: 16px 0;
    --sl-fbt-card-bg: #fff;
    --sl-fbt-card-border: #e5e5e5;
    --sl-fbt-card-padding: 16px;
    --sl-fbt-card-radius: 12px;
    --sl-fbt-slide-width: 220px;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-inner { padding: 24px 0; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-heading { font-size: 24px; margin: 0 0 16px 0; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-swiper { overflow: hidden; position: relative; }
  #sl-fbt-block-{{ block_id }} .swiper-wrapper { display: flex; gap: 5px; }
  #sl-fbt-block-{{ block_id }} .swiper-slide {
    flex-shrink: 0;
    width: var(--sl-fbt-slide-width) !important;
    height: auto;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card {
    padding: 0;
    border-radius: var(--sl-fbt-card-radius);
    border: 1px solid var(--sl-fbt-card-border);
    background: var(--sl-fbt-card-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column;
    gap: 2px;
    height: 100%;
    box-sizing: border-box;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__figure {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: calc(var(--sl-fbt-card-radius) - 2px);
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__media {
    display: block;
    width: 100%;
    height: 100%;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-badge {
    position: absolute;
    left: 8px;
    bottom: 8px;
    margin: 0;
    padding: 4px 8px;
    font-size: 11px;
    color: #333;
    background: #eee;
    border-radius: 4px;
    z-index: 2;
  }
  #sl-fbt-block-{{ block_id }}.sl-fbt-rtl .sl-fbt-badge { left: auto; right: 8px; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-add-wrap {
    position: absolute;
    right: 8px;
    bottom: 8px;
    z-index: 2;
  }
  #sl-fbt-block-{{ block_id }}.sl-fbt-rtl .sl-fbt-add-wrap { right: auto; left: 8px; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__info {
    display: flex;
    flex-direction: column;
    gap: 1px;
    flex: 1;
    padding-left: 8px;
    padding-right: 8px;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__title {
    font-size: 14px;
    font-weight: 500;
    color: inherit;
    text-decoration: none;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__title:hover { text-decoration: underline; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-card__price { font-size: 14px; font-weight: 600; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-rating {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #666;
    text-decoration: none;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-rating:hover { color: inherit; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-rating-wrap:has(.jdgm-preview-badge .jdgm-star) .sl-fbt-rating { display: none !important; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-rating__stars { display: flex; gap: 1px; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-rating-wrap { display: flex; align-items: center; gap: 8px; min-height: 18px; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-judgeme:empty { display: none; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-rating__stars svg { width: 12px; height: 12px; fill: #1c1c1c; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-price--compare {
    font-size: 12px;
    font-weight: 400;
    opacity: 0.7;
    text-decoration: line-through;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-add {
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 600;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  #sl-fbt-block-{{ block_id }} .sl-fbt-add:hover:not(:disabled) { opacity: 0.9; }
  #sl-fbt-block-{{ block_id }} .sl-fbt-add:disabled { opacity: 0.5; cursor: not-allowed; }
  @keyframes sl-fbt-pulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 0.5; } }
  #sl-fbt-block-{{ block_id }} .sl-fbt-add.is-loading { animation: sl-fbt-pulse 0.8s ease-in-out infinite; pointer-events: none; }
  #sl-fbt-block-{{ block_id }} .swiper-button-prev,
  #sl-fbt-block-{{ block_id }} .swiper-button-next,
  #sl-fbt-block-{{ block_id }} .swiper-button-prev::after,
  #sl-fbt-block-{{ block_id }} .swiper-button-next::after,
  #sl-fbt-block-{{ block_id }} .swiper-button-prev svg,
  #sl-fbt-block-{{ block_id }} .swiper-button-next svg { color: #000 !important; fill: #000 !important; stroke: #000 !important; }
  #sl-fbt-block-{{ block_id }}.sl-fbt-rtl .sl-fbt-inner,
  #sl-fbt-block-{{ block_id }}.sl-fbt-rtl .sl-fbt-heading { text-align: right; }
  #sl-fbt-block-{{ block_id }}.sl-fbt-rtl .sl-fbt-card { text-align: right; }
  #sl-fbt-block-{{ block_id }} .swiper-pagination { display: none !important; }
</style>

<script>
(function() {
  var blockId = '{{ block_id }}';
  var productId = '{{ prod.id }}';
  var isRtl = {{ is_rtl }};
  var rootPath = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) || '/';
  var moneyFormat = {{ shop.money_format | json }};
  var i18n = {
    loading: {{ 'sections.sl_fbt.loading' | t | json }},
    heading: {{ 'sections.sl_fbt.heading' | t | json }},
    percent_bought: {{ 'sections.sl_fbt.percent_bought' | t | json }},
    add: {{ 'sections.sl_fbt.add' | t | json }},
    adding: {{ 'sections.sl_fbt.adding' | t | json }},
    added: {{ 'sections.sl_fbt.added' | t | json }},
    sold_out: {{ 'sections.sl_fbt.sold_out' | t | json }},
    no_image: {{ 'sections.sl_fbt.no_image' | t | json }}
  };
  var SWIPER_CSS = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css';
  var SWIPER_JS = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';

  function formatMoney(cents) {
    if (typeof Shopify !== 'undefined' && Shopify.formatMoney) return Shopify.formatMoney(cents);
    var fmt = (typeof moneyFormat === 'string' && moneyFormat) || '${{amount}}';
    var val = (cents / 100).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    return fmt.replace(/\{\{\s*amount\s*\}\}/, val).replace(/\{\{\s*amount_no_decimals\s*\}\}/, Math.round(cents / 100));
  }

  function pctForIndex(i, productId) {
    var seeds = [54, 45, 38, 32, 30];
    var ranges = [12, 10, 8, 7, 6];
    var base = i < 5 ? seeds[i] : 30;
    var range = i < 5 ? ranges[i] : 6;
    var seed = (productId || 0) % 100;
    return base + (seed % range);
  }

  function buildCard(p, i, rootPath) {
    var base = (rootPath && rootPath.replace(/\/$/, '')) || '';
    var productPath = '/products/' + (p.handle || '');
    var url = base + productPath;
    var img = p.featured_image || p.image || (p.featured_media && p.featured_media.preview_image && p.featured_media.preview_image.src) || (p.images && p.images[0]) || (p.variants && p.variants[0] && p.variants[0].featured_image) || '';
    var imgSrc = (typeof img === 'string' ? img : (img && (img.src || img.url))) || '';
    if (imgSrc) {
      imgSrc = String(imgSrc).trim();
      var cdnIdx = imgSrc.indexOf('cdn.shopify.com');
      if (cdnIdx > 0) imgSrc = imgSrc.substring(cdnIdx);
      imgSrc = imgSrc.replace(/^\/\//, 'https://');
      if (imgSrc.indexOf('http') !== 0) {
        imgSrc = (imgSrc.charAt(0) === '/' ? 'https://cdn.shopify.com' : 'https://') + imgSrc;
      }
    }
    var variantId = (p.variants && p.variants[0] && p.variants[0].id) || '';
    var price = p.price != null ? formatMoney(p.price) : '';
    var comparePrice = (p.compare_at_price && p.compare_at_price > (p.price || 0)) ? formatMoney(p.compare_at_price) : '';
    var available = p.available !== false;
    var imgHtml = imgSrc
      ? '<img src="' + imgSrc + '" alt="' + (p.title || '').replace(/"/g, '&quot;') + '" width="260" height="260" loading="lazy">'
      : '<div style="width:100%;height:100%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;">' + i18n.no_image + '</div>';
    var pct = pctForIndex(i, p.id);
    var badgeText = (i18n.percent_bought || '{{ count }}% Bought together').replace(/\{\{\s*count\s*\}\}/g, pct);
    var badgeHtml = '<label class="sl-fbt-badge">' + badgeText + '</label>';
    var priceHtml = comparePrice
      ? '<span class="sl-fbt-price--sale">' + price + '</span><span class="sl-fbt-price--compare">' + comparePrice + '</span>'
      : price;
    var btnHtml = available
      ? '<div class="sl-fbt-add-wrap"><form class="sl-fbt-form" data-variant-id="' + variantId + '">' +
        '<button type="submit" class="sl-fbt-add">' + i18n.add + '</button></form></div>'
      : '<div class="sl-fbt-add-wrap"><button type="button" class="sl-fbt-add" disabled>' + i18n.sold_out + '</button></div>';
    var starSvg = '<svg viewBox="0 0 12 11"><path d="M6 0v8.635L2.292 11 3.48 6.87 0 4.202l4.443-.187L6 0Zm0 0v8.635L9.708 11 8.52 6.87 12 4.202l-4.443-.187L6 0Z" fill="#1c1c1c"/></svg>';
    var ratingVal = (p.rating != null && p.rating !== '') ? parseFloat(p.rating) : null;
    var ratingCount = (p.reviews_count != null) ? parseInt(p.reviews_count, 10) : null;
    if (ratingVal == null || isNaN(ratingVal)) {
      ratingVal = 4.6 + ((p.id || 0) % 5) * 0.1;
    }
    var ratingHtml = '<a href="' + url + '#shopify-product-reviews" class="sl-fbt-rating" data-product-id="' + (p.id || '') + '" title="' + (ratingCount ? ratingCount + ' reviews' : 'Reviews') + '">';
    var fullStars = Math.floor(ratingVal);
    var halfStar = (ratingVal % 1) >= 0.5 ? 1 : 0;
    var emptyStars = 5 - fullStars - halfStar;
    ratingHtml += '<div class="sl-fbt-rating__stars" role="img" aria-label="' + ratingVal + ' out of 5.0 stars">';
    for (var s = 0; s < fullStars; s++) ratingHtml += starSvg;
    if (halfStar) ratingHtml += '<span style="opacity:0.6">' + starSvg + '</span>';
    for (var s = 0; s < emptyStars; s++) ratingHtml += '<span style="opacity:0.3">' + starSvg + '</span>';
    ratingHtml += '</div><span class="sl-fbt-rating__value">(' + ratingVal.toFixed(1) + ')</span>';
    ratingHtml += '</a>';
    var judgeMeHtml = '<div class="jdgm-widget jdgm-preview-badge sl-fbt-judgeme" data-id="' + (p.id || '') + '" data-product-id="' + (p.id || '') + '"></div>';
    return '<div class="swiper-slide"><div class="sl-fbt-card" data-product-id="' + (p.id || '') + '">' +
      '<div class="sl-fbt-card__figure">' +
      '<a href="' + url + '" class="sl-fbt-card__media">' + imgHtml + '</a>' +
      badgeHtml + btnHtml +
      '</div>' +
      '<div class="sl-fbt-card__info">' +
      '<a href="' + url + '" class="sl-fbt-card__title">' + (p.title || '').replace(/</g, '&lt;') + '</a>' +
      '<div class="sl-fbt-card__price">' + priceHtml + '</div>' +
      '<div class="sl-fbt-rating-wrap">' + judgeMeHtml + ratingHtml + '</div></div></div></div>';
  }

  function loadSwiper(cb) {
    if (typeof Swiper !== 'undefined') { cb(); return; }
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = SWIPER_CSS;
    document.head.appendChild(link);
    var s = document.createElement('script');
    s.src = SWIPER_JS;
    s.onload = cb;
    document.head.appendChild(s);
  }

  function refreshCartCount(count) {
    var sel = '.cart-count-bubble, .cart-count, [data-cart-count], .header__icon--cart .count, [data-header-cart-count], .cart-icon__count';
    document.querySelectorAll(sel).forEach(function(el) { el.textContent = count; });
  }

  function updateCartFromSections(sections) {
    if (!sections || typeof sections !== 'object') return;
    for (var id in sections) {
      var html = sections[id];
      if (!html) continue;
      var sel = id.replace(/_/g, '-');
      var el = document.querySelector('[id*="' + sel + '"]') || document.querySelector('[id*="' + id + '"]');
      if (el) el.innerHTML = html;
    }
  }

  function setupAjaxAddToCart(container) {
    container.addEventListener('submit', function(e) {
      var form = e.target;
      if (!form || !form.classList.contains('sl-fbt-form')) return;
      e.preventDefault();
      var variantId = form.getAttribute('data-variant-id');
      var btn = form.querySelector('.sl-fbt-add');
      if (!variantId || !btn) return;
      btn.disabled = true;
      btn.classList.add('is-loading');
      btn.textContent = i18n.adding;
      var sectionsToRender = 'cart-icon-bubble,cart-drawer,cart-live-region-text';
      fetch(rootPath + 'cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({
          items: [{ id: parseInt(variantId, 10), quantity: 1 }],
          sections: sectionsToRender,
          sections_url: window.location.pathname
        })
      }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.status === 422 || (data.status && data.status >= 400)) throw new Error(data.description || data.message || 'Error');
        btn.classList.remove('is-loading');
        btn.textContent = i18n.added;
        if (data.sections) updateCartFromSections(data.sections);
        fetch(rootPath + 'cart.js').then(function(r) { return r.json(); }).then(function(c) { refreshCartCount(c.item_count || 0); }).catch(function() {});
        document.dispatchEvent(new CustomEvent('cart:refresh'));
        if (typeof window.theme !== 'undefined' && window.theme.refreshCart) window.theme.refreshCart();
        setTimeout(function() { btn.disabled = false; btn.textContent = i18n.add; }, 2000);
      }).catch(function() {
        btn.classList.remove('is-loading');
        btn.disabled = false;
        btn.textContent = i18n.add;
      });
    });
  }

  function initSwiper(container) {
    var el = container.querySelector('.sl-fbt-swiper');
    if (!el || typeof Swiper === 'undefined') return;
    if (el.swiper) return;
    var nextEl = container.querySelector('.swiper-button-next');
    var prevEl = container.querySelector('.swiper-button-prev');
    new Swiper(el, {
      slidesPerView: 'auto',
      spaceBetween: 5,
      loop: false,
      rtl: isRtl,
      navigation: (nextEl && prevEl) ? { nextEl: nextEl, prevEl: prevEl } : false,
      pagination: false
    });
  }

  function run(retries) {
    retries = retries || 0;
    var root = document.getElementById('sl-fbt-block-' + blockId);
    if (!root || !productId) {
      if (!root && productId && retries < 20) setTimeout(function() { run(retries + 1); }, 100);
      return;
    }
    var ph = root.querySelector('.sl-fbt-fetch-placeholder');
    function fetchAndRender(intent) {
      var url = rootPath + 'recommendations/products.json?product_id=' + productId + '&limit=10&intent=' + intent;
      return fetch(url).then(function(r) {
        if (!r.ok) return null;
        return r.json();
      }).then(function(data) {
        if (!data || !ph) return [];
        return (data.products || []);
      });
    }

    function fetchFallbackProducts() {
      return fetch(rootPath + 'collections/all/products.json?limit=20').then(function(r) {
        if (!r.ok) return [];
        return r.json();
      }).then(function(data) {
        var list = (data && data.products) ? data.products : (data && data.collection && data.collection.products) ? data.collection.products : [];
        return list.filter(function(p) { return p && String(p.id) !== String(productId); }).slice(0, 5);
      }).catch(function() { return []; });
    }

    fetchAndRender('complementary').then(function(products) {
      if (products.length === 0) return fetchAndRender('related');
      return products;
    }).then(function(products) {
      if (!products || products.length === 0) return fetchFallbackProducts();
      return products;
    }).then(function(products) {
      if (!ph) return;
      if (!products || products.length === 0) { ph.style.display = 'none'; return; }
      var html = '<div class="sl-fbt-inner">' +
        '<h2 class="sl-fbt-heading">' + i18n.heading + '</h2>' +
        '<div class="sl-fbt-swiper swiper"><div class="swiper-wrapper">';
      for (var i = 0; i < products.length; i++) {
        html += buildCard(products[i], i, rootPath);
      }
      html += '</div>' +
        '<div class="swiper-button-prev"></div><div class="swiper-button-next"></div>' +
        '</div></div>';
      root.innerHTML = html;
      setupAjaxAddToCart(root);
      loadSwiper(function() { initSwiper(root); });
      if (typeof JDGM !== 'undefined' && JDGM.initBadges) JDGM.initBadges();
      else if (typeof window.jdgm !== 'undefined' && window.jdgm.initBadges) window.jdgm.initBadges();
      document.dispatchEvent(new CustomEvent('sl-fbt:rendered'));
    }).catch(function() {
      if (ph) ph.style.display = 'none';
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();
</script>
{% endif %}
