{% comment %}
  SL - Social Proof Video Slider
  Product-specific UGC videos via metaobjects, or static videos via section blocks.
  Add to product template. Uses product.metafields.custom.social_proof_videos (list of UGC Video metaobjects).
  See README.md for setup.
{% endcomment %}

{% comment %} Resolve video source: product metaobject OR section blocks {% endcomment %}
{% assign video_source = section.settings.video_source %}
{% assign ugc_videos = product.metafields.custom.social_proof_videos.value | default: nil %}
{% assign use_metaobject = false %}
{% if video_source == 'product_metaobject' and product != blank and ugc_videos != blank and ugc_videos.size > 0 %}
  {% assign use_metaobject = true %}
{% endif %}

{% assign has_videos = false %}
{% if use_metaobject %}
  {% assign has_videos = true %}
{% elsif section.blocks.size > 0 %}
  {% for block in section.blocks %}
    {% assign vf = block.settings.video_file %}
    {% assign mp4 = vf.sources | where: 'format', 'mp4' | first %}
    {% if mp4 and mp4.url != blank %}
      {% assign has_videos = true %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% unless has_videos %}
  {% comment %} No videos to show; section renders nothing (or placeholder in theme editor) {% endcomment %}
  {% if request.design_mode %}
    <div id="sl-spv-section-{{ section.id }}" class="sl-spv-block-root" style="background: {{ section.settings.background_color }}; padding: 24px; text-align: center; border: 2px dashed #ccc;">
      <p style="margin: 0; color: #666;">Social Proof Video ‚Äî No videos. Add UGC Video metaobject entries to this product's <strong>Social proof videos</strong> metafield, or add Video slide blocks.</p>
    </div>
  {% endif %}
{% else %}
<div id="sl-spv-section-{{ section.id }}" class="sl-spv-block-root" style="background-color: {{ section.settings.background_color }}; padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;">
  <div class="sl-spv-inner" style="{% unless section.settings.full_width %}max-width: {{ section.settings.content_width }}px; margin-left: auto; margin-right: auto;{% endunless %} padding-left: 16px; padding-right: 16px;">
    {% if section.settings.section_heading != blank %}
      <h2 class="sl-spv-heading" style="text-align: {{ section.settings.heading_alignment }}; font-size: {% if section.settings.heading_size == 'small' %}20px{% elsif section.settings.heading_size == 'medium' %}24px{% else %}32px{% endif %}; color: {{ section.settings.heading_color }}; margin: 0 0 16px 0;">{{ section.settings.section_heading }}</h2>
    {% endif %}

    <div class="sl-spv-swiper swiper" data-slides-desktop="{{ section.settings.slides_visible_desktop }}" data-slides-mobile="{{ section.settings.slides_visible_mobile }}" data-gap="{{ section.settings.slide_gap }}">
      <div class="swiper-wrapper">
      {% if use_metaobject %}
        {% for entry in ugc_videos %}
          {% assign video_file = entry.video %}
          {% if video_file != blank %}
            {% assign video_url = nil %}
            {% assign video_mtag = video_file | metafield_tag %}
            {% assign file_obj = video_file.value | default: video_file %}
            {% assign mp4_source = video_file.sources | where: 'format', 'mp4' | first %}
            {% if mp4_source and mp4_source.url != blank %}
              {% assign video_url = mp4_source.url %}
            {% elsif video_file.url != blank %}
              {% assign video_url = video_file.url %}
            {% elsif file_obj.url != blank %}
              {% assign video_url = file_obj.url %}
            {% endif %}
            {% if video_url != blank %}
              <div class="swiper-slide sl-spv-slide">
                <div class="sl-spv-card {{ section.settings.aspect_ratio }}" style="border-radius: {{ section.settings.border_radius }}px;{% if section.settings.border_thickness > 0 %} border: {{ section.settings.border_thickness }}px solid {{ section.settings.border_color }};{% endif %}">
                  <video
                    {% if forloop.first %}src="{{ video_url }}" autoplay{% else %}data-src="{{ video_url }}"{% endif %}
                    poster="{% if video_file.preview_image %}{{ video_file.preview_image | image_url: width: 1200 }}{% endif %}"
                    muted loop playsinline
                    preload="{% if forloop.first %}auto{% else %}metadata{% endif %}"
                    class="sl-spv-video"
                  ></video>
                  <div class="sl-spv-footer">
                    {% if section.settings.show_caption and (entry.caption != blank or entry.username != blank) %}
                      <div class="sl-spv-caption" style="color: {{ section.settings.caption_color }};">
                        {% if entry.username != blank %}<span class="sl-spv-caption-username">{{ entry.username }}</span>{% endif %}
                        {% if entry.caption != blank %}<span class="sl-spv-caption-text">{{ entry.caption }}</span>{% endif %}
                      </div>
                    {% endif %}
                    <div class="sl-spv-controls">
                      <button type="button" class="sl-spv-mute" data-state="muted" aria-label="Mute / Unmute"><span class="mute-icon">üîá</span><span class="unmute-icon">üîä</span></button>
                    </div>
                  </div>
                </div>
              </div>
            {% elsif video_mtag != blank %}
              <div class="swiper-slide sl-spv-slide">
                <div class="sl-spv-card sl-spv-metafield {{ section.settings.aspect_ratio }}" style="border-radius: {{ section.settings.border_radius }}px;{% if section.settings.border_thickness > 0 %} border: {{ section.settings.border_thickness }}px solid {{ section.settings.border_color }};{% endif %}">
                  <div class="sl-spv-metafield-wrap">{{ video_mtag }}</div>
                  <div class="sl-spv-footer">
                    {% if section.settings.show_caption and (entry.caption != blank or entry.username != blank) %}
                      <div class="sl-spv-caption" style="color: {{ section.settings.caption_color }};">
                        {% if entry.username != blank %}<span class="sl-spv-caption-username">{{ entry.username }}</span>{% endif %}
                        {% if entry.caption != blank %}<span class="sl-spv-caption-text">{{ entry.caption }}</span>{% endif %}
                      </div>
                    {% endif %}
                    <div class="sl-spv-controls">
                      <button type="button" class="sl-spv-mute" data-state="muted" aria-label="Mute / Unmute"><span class="mute-icon">üîá</span><span class="unmute-icon">üîä</span></button>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% for block in section.blocks %}
          {% assign video_file = block.settings.video_file %}
          {% assign mp4_source = video_file.sources | where: 'format', 'mp4' | first %}
          {% if mp4_source and mp4_source.url != blank %}
            <div class="swiper-slide sl-spv-slide" {{ block.shopify_attributes }}>
              <div class="sl-spv-card {{ section.settings.aspect_ratio }}" style="border-radius: {{ section.settings.border_radius }}px;{% if section.settings.border_thickness > 0 %} border: {{ section.settings.border_thickness }}px solid {{ section.settings.border_color }};{% endif %}">
                <video
                  {% if forloop.first %}src="{{ mp4_source.url }}" autoplay{% else %}data-src="{{ mp4_source.url }}"{% endif %}
                  poster="{% if video_file.preview_image %}{{ video_file.preview_image | image_url: width: 1200 }}{% endif %}"
                  muted loop playsinline
                  preload="{% if forloop.first %}auto{% else %}metadata{% endif %}"
                  class="sl-spv-video"
                ></video>
                <div class="sl-spv-footer">
                  <div class="sl-spv-controls">
                    <button type="button" class="sl-spv-mute" data-state="muted" aria-label="Mute / Unmute"><span class="mute-icon">üîá</span><span class="unmute-icon">üîä</span></button>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
      </div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </div>
</div>

<style>
  #sl-spv-section-{{ section.id }}.sl-spv-block-root { width: 100%; margin: 0; }
  #sl-spv-section-{{ section.id }} .sl-spv-inner { padding: 0; }
  #sl-spv-section-{{ section.id }} .sl-spv-swiper { overflow: hidden; position: relative; }
  #sl-spv-section-{{ section.id }} .swiper-slide { opacity: 1 !important; filter: none !important; }
  #sl-spv-section-{{ section.id }} .swiper-wrapper { display: flex; gap: 0; }
  #sl-spv-section-{{ section.id }} .swiper-slide { flex-shrink: 0; height: auto; box-sizing: border-box; }
  #sl-spv-section-{{ section.id }} .sl-spv-card {
    position: relative;
    overflow: hidden;
    background: #000;
    cursor: pointer;
    height: 100%;
  }
  #sl-spv-section-{{ section.id }} .sl-spv-metafield-wrap { position: absolute; inset: 0; width: 100%; height: 100%; }
  #sl-spv-section-{{ section.id }} .sl-spv-video,
  #sl-spv-section-{{ section.id }} .sl-spv-card video {
    width: 100%; height: 100%; object-fit: cover; display: block; border-radius: inherit; pointer-events: none;
  }
  #sl-spv-section-{{ section.id }} .sl-spv-card video::-webkit-media-controls { display: none !important; }
  #sl-spv-section-{{ section.id }} .swiper-slide-active .sl-spv-footer { display: flex; }
  #sl-spv-section-{{ section.id }} .sl-spv-footer {
    position: absolute; bottom: 0; left: 0; right: 0;
    display: none; align-items: flex-end; justify-content: space-between; gap: 0.5rem;
    padding: 0.75rem 0.5rem 0.5rem;
    background: linear-gradient(to top, rgba(255,255,255,0.3), transparent);
    z-index: 10; pointer-events: none;
  }
  #sl-spv-section-{{ section.id }} .sl-spv-footer .sl-spv-controls { pointer-events: auto; }
  #sl-spv-section-{{ section.id }} .sl-spv-caption { flex: 1; min-width: 0; font-size: 12px; line-height: 1.4; z-index: 1; }
  #sl-spv-section-{{ section.id }} .sl-spv-caption-username { font-weight: 600; display: block; }
  #sl-spv-section-{{ section.id }} .sl-spv-controls { display: flex; gap: 0.25rem; flex-shrink: 0; }
  #sl-spv-section-{{ section.id }} .sl-spv-controls button {
    background: transparent; border: none; padding: 0.25rem;
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
    font-size: 0; color: #000; cursor: pointer; pointer-events: auto;
  }
  #sl-spv-section-{{ section.id }} .sl-spv-controls .mute-icon, #sl-spv-section-{{ section.id }} .sl-spv-controls .unmute-icon { font-size: 14px; color: inherit; }
  #sl-spv-section-{{ section.id }} .sl-spv-mute[data-state="muted"] .unmute-icon { display: none; }
  #sl-spv-section-{{ section.id }} .sl-spv-mute[data-state="unmuted"] .mute-icon { display: none; }
  #sl-spv-section-{{ section.id }} .swiper-button-prev, #sl-spv-section-{{ section.id }} .swiper-button-next,
  #sl-spv-section-{{ section.id }} .swiper-button-prev::after, #sl-spv-section-{{ section.id }} .swiper-button-next::after { color: #000 !important; }
  #sl-spv-section-{{ section.id }} .swiper-pagination { display: none !important; }
  #sl-spv-section-{{ section.id }} .aspect-16-9 { aspect-ratio: 16 / 9; }
  #sl-spv-section-{{ section.id }} .aspect-9-16 { aspect-ratio: 9 / 16; }
  #sl-spv-section-{{ section.id }} .aspect-1-1 { aspect-ratio: 1 / 1; }
  {% unless section.settings.arrows_show_mobile %}
  @media (max-width: 768px) {
    #sl-spv-section-{{ section.id }} .swiper-button-prev, #sl-spv-section-{{ section.id }} .swiper-button-next { display: none !important; }
  }
  {% endunless %}
  {% unless section.settings.arrows_show_desktop %}
  @media (min-width: 769px) {
    #sl-spv-section-{{ section.id }} .swiper-button-prev, #sl-spv-section-{{ section.id }} .swiper-button-next { display: none !important; }
  }
  {% endunless %}
</style>

<script>
(function() {
  var sectionId = '{{ section.id }}';
  var root = document.getElementById('sl-spv-section-' + sectionId);
  if (!root) return;
  var SWIPER_CSS = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css';
  var SWIPER_JS = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';
  var slidesDesktop = {{ section.settings.slides_visible_desktop }};
  var slidesMobile = {{ section.settings.slides_visible_mobile }};
  var gap = {{ section.settings.slide_gap }};
  var autoplaySetting = {{ section.settings.autoplay_active | json }};

  function ensureVideoSrc(v) {
    if (!v) return;
    var src = v.getAttribute('data-src');
    if (src && !v.src) v.src = src;
  }

  function loadSwiper(cb) {
    if (typeof Swiper !== 'undefined') { cb(); return; }
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = SWIPER_CSS;
    document.head.appendChild(link);
    var s = document.createElement('script');
    s.src = SWIPER_JS;
    s.onload = cb;
    document.head.appendChild(s);
  }

  function run() {
    var r = document.getElementById('sl-spv-section-' + sectionId);
    if (!r) return;
    var swiperEl = r.querySelector('.sl-spv-swiper');
    var slides = r.querySelectorAll('.sl-spv-card');
    if (!swiperEl || slides.length === 0) return;

    var autoplay = autoplaySetting;
    var isMuted = true;
    var swiperInstance = null;

    function playFocusedVideo() {
      if (!swiperInstance) return;
      var idx = swiperInstance.activeIndex;
      var activeSlide = swiperInstance.slides[idx];
      var focusedCard = activeSlide ? activeSlide.querySelector('.sl-spv-card') : null;
      var focusedVideo = focusedCard ? focusedCard.querySelector('video') : null;

      r.querySelectorAll('.sl-spv-card video').forEach(function(v) { if (v) v.pause(); });

      if (focusedVideo && autoplay) {
        ensureVideoSrc(focusedVideo);
        focusedVideo.muted = isMuted;
        var src = focusedVideo.src || focusedVideo.currentSrc || focusedVideo.getAttribute('data-src');
        var sourceEl = focusedVideo.querySelector('source');
        if (sourceEl && !src) src = sourceEl.src || sourceEl.getAttribute('src');
        if (src && !focusedVideo.src) focusedVideo.src = src;
        var hasSrc = focusedVideo.src || focusedVideo.currentSrc || (sourceEl && sourceEl.src);
        if (hasSrc) {
          var doPlay = function() {
            focusedVideo.muted = isMuted;
            if (!isMuted) focusedVideo.volume = 1;
            focusedVideo.play().catch(function(){});
          };
          if (focusedVideo.readyState >= 2) doPlay();
          else {
            focusedVideo.addEventListener('loadeddata', doPlay, { once: true });
            focusedVideo.addEventListener('canplay', doPlay, { once: true });
            focusedVideo.load();
          }
        }
      }
    }

    loadSwiper(function() {
      if (swiperEl.swiper) return;
      var slidesPerView = window.innerWidth <= 768 ? slidesMobile : slidesDesktop;
      swiperInstance = new Swiper(swiperEl, {
        slidesPerView: slidesPerView,
        spaceBetween: gap,
        slidesOffsetAfter: 60,
        slidesOffsetBefore: 0,
        watchSlidesProgress: false,
        loop: false,
        navigation: {
          nextEl: r.querySelector('.swiper-button-next'),
          prevEl: r.querySelector('.swiper-button-prev')
        },
        on: {
          slideChange: function() { playFocusedVideo(); },
          init: function() { setTimeout(playFocusedVideo, 50); }
        }
      });

      var ro = new ResizeObserver(function() {
        if (!swiperInstance) return;
        var spv = window.innerWidth <= 768 ? slidesMobile : slidesDesktop;
        swiperInstance.params.slidesPerView = spv;
        swiperInstance.params.spaceBetween = gap;
        swiperInstance.params.slidesOffsetAfter = 60;
        swiperInstance.update();
      });
      if (swiperEl.parentElement) ro.observe(swiperEl.parentElement);

      slides.forEach(function(card) {
        card.addEventListener('click', function(e) {
          if (e.target.closest('.sl-spv-controls')) return;
          isMuted = !isMuted;
          r.querySelectorAll('.sl-spv-mute').forEach(function(b) { b.setAttribute('data-state', isMuted ? 'muted' : 'unmuted'); });
          var av = r.querySelector('.swiper-slide-active video');
          if (av) { av.muted = isMuted; if (!isMuted) av.volume = 1; }
        });
      });

      r.querySelectorAll('.sl-spv-mute').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          isMuted = !isMuted;
          r.querySelectorAll('.sl-spv-mute').forEach(function(b) { b.setAttribute('data-state', isMuted ? 'muted' : 'unmuted'); });
          var av = r.querySelector('.swiper-slide-active video');
          if (av) { av.muted = isMuted; if (!isMuted) av.volume = 1; }
        });
      });

    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
  else run();
})();
</script>
{% endunless %}

{% schema %}
{
  "name": "SL - Social Proof Video",
  "tag": "section",
  "class": "sl-social-proof-section",
  "settings": [
    {
      "type": "header",
      "content": "üìπ Video source"
    },
    {
      "type": "select",
      "id": "video_source",
      "label": "Video source",
      "info": "Product metaobject = per-product UGC videos. Section blocks = static videos from theme editor.",
      "options": [
        { "value": "product_metaobject", "label": "Product metaobject (per product)" },
        { "value": "section_blocks", "label": "Section blocks (static)" }
      ],
      "default": "product_metaobject"
    },
    {
      "type": "header",
      "content": "üìù Heading"
    },
    {
      "type": "text",
      "id": "section_heading",
      "label": "Section heading",
      "default": "Real reviews"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "‚öôÔ∏è Slider settings"
    },
    {
      "type": "range",
      "id": "slides_visible_desktop",
      "label": "Slides per view (desktop)",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "slides_visible_mobile",
      "label": "Slides per view (mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 1
    },
    {
      "type": "range",
      "id": "slide_gap",
      "label": "Slider gap (px)",
      "min": 0,
      "max": 100,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "lazy_load",
      "label": "Lazy load videos",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay_active",
      "label": "Autoplay active slide",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "staggered_slides",
      "label": "Staggered slides effect",
      "default": true
    },
    {
      "type": "header",
      "content": "üìã Caption (metaobject only)"
    },
    {
      "type": "checkbox",
      "id": "show_caption",
      "label": "Show caption & username from metaobject",
      "default": true
    },
    {
      "type": "color",
      "id": "caption_color",
      "label": "Caption color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "üéûÔ∏è Slide styling"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Slide border radius (px)",
      "info": "Matches FBT at 12px for consistency.",
      "min": 0,
      "max": 40,
      "step": 1,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_thickness",
      "label": "Slide border thickness (px)",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Slide border color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Media aspect ratio",
      "options": [
        { "label": "9:16 (Portrait, tall)", "value": "aspect-9-16" },
        { "label": "16:9 (Landscape)", "value": "aspect-16-9" },
        { "label": "1:1 (Square)", "value": "aspect-1-1" }
      ],
      "default": "aspect-9-16"
    },
    {
      "type": "header",
      "content": "‚èØÔ∏è Controls styling"
    },
    {
      "type": "range",
      "id": "control_button_size",
      "label": "Play / Mute button size (px)",
      "min": 20,
      "max": 100,
      "step": 2,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "play_button_color",
      "label": "Play button color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "mute_button_color",
      "label": "Mute button color",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "icon_mute",
      "label": "Mute icon (optional)"
    },
    {
      "type": "image_picker",
      "id": "icon_unmute",
      "label": "Unmute icon (optional)"
    },
    {
      "type": "image_picker",
      "id": "icon_play",
      "label": "Play icon (optional)"
    },
    {
      "type": "image_picker",
      "id": "icon_pause",
      "label": "Pause icon (optional)"
    },
    {
      "type": "header",
      "content": "‚û°Ô∏è Arrows"
    },
    {
      "type": "checkbox",
      "id": "arrows_show_desktop",
      "label": "Show arrows on desktop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "arrows_show_mobile",
      "label": "Show arrows on mobile",
      "default": true
    },
    {
      "type": "color",
      "id": "arrow_icon_color",
      "label": "Arrow icon color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "arrow_bg_color",
      "label": "Arrow background color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "arrow_size",
      "label": "Arrow size (px)",
      "min": 12,
      "max": 120,
      "step": 12,
      "default": 36,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "üé® Section styling"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Section background color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 36,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 36,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width section",
      "default": false
    },
    {
      "type": "range",
      "id": "content_width",
      "label": "Content width (if not full width)",
      "min": 400,
      "max": 1600,
      "step": 20,
      "default": 1200,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Video slide",
      "settings": [
        {
          "type": "video",
          "id": "video_file",
          "label": "Video file"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "SL - Social Proof Video",
      "category": "Media",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ],
  "templates": ["product"]
}
{% endschema %}
