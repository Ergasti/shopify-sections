{% comment %}
  SL - Social Proof Video (Snippet)
  Use in product info via Custom Liquid block.
  Usage: {% render 'sl-social-proof-video', product: product, block_id: block.id %}
  Requires product.metafields.custom.social_proof_videos (UGC Video metaobjects).
  Uses Swiper (same as FBT). See README.md for metaobject setup.
{% endcomment %}

{% assign block_id = block_id | default: 'spv' %}
{% assign prod = product | default: nil %}
{% assign show_debug = debug | default: false %}
{% if request.design_mode %}
  {% assign show_debug = true %}
{% endif %}
{% assign ugc_videos = prod.metafields.custom.social_proof_videos.value | default: nil %}
{% assign has_videos = false %}
{% if prod != blank and ugc_videos != blank and ugc_videos.size > 0 %}
  {% assign has_videos = true %}
{% endif %}

{% if show_debug %}
  <div class="sl-spv-debug" style="padding:12px;margin:12px 0;background:#f5f5f5;border:1px solid #ccc;font-size:12px;font-family:monospace;">
    <strong>Social Proof Video â€” Debug</strong>
    <ul style="margin:8px 0 0 0;padding-left:18px;">
      <li>product: {% if prod %}yes (id: {{ prod.id }}){% else %}no{% endif %}</li>
      <li>ugc_videos: {% if ugc_videos %}yes, count {{ ugc_videos.size }}{% else %}no{% endif %}</li>
    </ul>
  </div>
{% endif %}

{% if has_videos %}
<div id="sl-spv-block-{{ block_id }}" class="sl-spv-block-root">
  <div class="sl-spv-inner">
    <h2 class="sl-spv-heading">See It In Action</h2>
    <div class="sl-spv-swiper swiper">
      <div class="swiper-wrapper">
        {% for entry in ugc_videos %}
          {% assign video_file = entry.video %}
          {% if video_file != blank %}
            {% assign video_url = nil %}
            {% assign video_mtag = video_file | metafield_tag %}
            {% assign mp4_source = video_file.sources | where: 'format', 'mp4' | first %}
            {% assign file_obj = video_file.value | default: video_file %}
            {% if mp4_source and mp4_source.url != blank %}
              {% assign video_url = mp4_source.url %}
            {% elsif video_file.url != blank %}
              {% assign video_url = video_file.url %}
            {% elsif file_obj.url != blank %}
              {% assign video_url = file_obj.url %}
            {% endif %}
            {% if video_url != blank %}
              <div class="swiper-slide">
                <div class="sl-spv-card sl-spv-slide">
                  <video
                    {% if forloop.first %}src="{{ video_url }}" autoplay{% else %}data-src="{{ video_url }}"{% endif %}
                    poster="{% if video_file.preview_image %}{{ video_file.preview_image | image_url: width: 1200 }}{% endif %}"
                    muted loop playsinline
                    preload="{% if forloop.first %}auto{% else %}metadata{% endif %}"
                    class="sl-spv-video"
                  ></video>
                  <div class="sl-spv-footer">
                    {% if entry.caption != blank or entry.username != blank %}
                      <div class="sl-spv-caption">
                        {% if entry.username != blank %}<span class="sl-spv-caption-username">{{ entry.username }}</span>{% endif %}
                        {% if entry.caption != blank %}<span class="sl-spv-caption-text">{{ entry.caption }}</span>{% endif %}
                      </div>
                    {% endif %}
                    <div class="sl-spv-controls">
                      <button type="button" class="sl-spv-mute" data-state="muted" aria-label="Mute / Unmute"><span class="mute-icon">ðŸ”‡</span><span class="unmute-icon">ðŸ”Š</span></button>
                    </div>
                  </div>
                </div>
              </div>
            {% elsif video_mtag != blank %}
              <div class="swiper-slide">
                <div class="sl-spv-card sl-spv-slide sl-spv-metafield">
                  <div class="sl-spv-metafield-wrap">{{ video_mtag }}</div>
                  <div class="sl-spv-footer">
                    {% if entry.caption != blank or entry.username != blank %}
                      <div class="sl-spv-caption">
                        {% if entry.username != blank %}<span class="sl-spv-caption-username">{{ entry.username }}</span>{% endif %}
                        {% if entry.caption != blank %}<span class="sl-spv-caption-text">{{ entry.caption }}</span>{% endif %}
                      </div>
                    {% endif %}
                    <div class="sl-spv-controls">
                      <button type="button" class="sl-spv-mute" data-state="muted" aria-label="Mute / Unmute"><span class="mute-icon">ðŸ”‡</span><span class="unmute-icon">ðŸ”Š</span></button>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </div>
</div>

<style>
  #sl-spv-block-{{ block_id }}.sl-spv-block-root {
    width: 100%;
    margin: 16px 0;
    --sl-spv-slide-width: 220px;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-inner { padding: 24px 0; }
  #sl-spv-block-{{ block_id }} .sl-spv-heading { font-size: 24px; margin: 0 0 16px 0; }
  #sl-spv-block-{{ block_id }} .sl-spv-swiper { overflow: hidden; position: relative; }
  #sl-spv-block-{{ block_id }} .swiper-slide { opacity: 1 !important; filter: none !important; }
  #sl-spv-block-{{ block_id }} .swiper-wrapper { display: flex; gap: 5px; }
  #sl-spv-block-{{ block_id }} .swiper-slide {
    flex-shrink: 0;
    width: var(--sl-spv-slide-width) !important;
    height: auto;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-card {
    position: relative;
    aspect-ratio: 9 / 16;
    overflow: hidden;
    background: #000;
    border-radius: 12px;
    cursor: pointer;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-metafield-wrap {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-video,
  #sl-spv-block-{{ block_id }} .sl-spv-card video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: inherit;
    pointer-events: none;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-card video::-webkit-media-controls { display: none !important; }
  #sl-spv-block-{{ block_id }} .swiper-slide-active .sl-spv-footer { display: flex; }
  #sl-spv-block-{{ block_id }} .sl-spv-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: none;
    align-items: flex-end;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.75rem 0.5rem 0.5rem;
    background: linear-gradient(to top, rgba(255,255,255,0.3), transparent);
    z-index: 10;
    pointer-events: none;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-footer .sl-spv-controls { pointer-events: auto; }
  #sl-spv-block-{{ block_id }} .sl-spv-caption {
    flex: 1;
    min-width: 0;
    font-size: 12px;
    line-height: 1.4;
    color: #000;
    z-index: 1;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-caption-username { font-weight: 600; display: block; }
  #sl-spv-block-{{ block_id }} .sl-spv-controls {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-controls button {
    background: transparent;
    border: none;
    padding: 0.25rem;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0;
    color: #000;
    cursor: pointer;
    pointer-events: auto;
  }
  #sl-spv-block-{{ block_id }} .sl-spv-controls .mute-icon,
  #sl-spv-block-{{ block_id }} .sl-spv-controls .unmute-icon { font-size: 14px; color: inherit; }
  #sl-spv-block-{{ block_id }} .sl-spv-mute[data-state="muted"] .unmute-icon { display: none; }
  #sl-spv-block-{{ block_id }} .sl-spv-mute[data-state="unmuted"] .mute-icon { display: none; }
  #sl-spv-block-{{ block_id }} .swiper-button-prev,
  #sl-spv-block-{{ block_id }} .swiper-button-next,
  #sl-spv-block-{{ block_id }} .swiper-button-prev::after,
  #sl-spv-block-{{ block_id }} .swiper-button-next::after { color: #000 !important; }
  #sl-spv-block-{{ block_id }} .swiper-pagination { display: none !important; }
</style>

<script>
(function() {
  var blockId = '{{ block_id }}';
  var root = document.getElementById('sl-spv-block-' + blockId);
  if (!root) return;
  var SWIPER_CSS = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css';
  var SWIPER_JS = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';

  function ensureVideoSrc(v) {
    if (!v) return;
    var src = v.getAttribute('data-src');
    if (src && !v.src) { v.src = src; }
  }

  function loadSwiper(cb) {
    if (typeof Swiper !== 'undefined') { cb(); return; }
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = SWIPER_CSS;
    document.head.appendChild(link);
    var s = document.createElement('script');
    s.src = SWIPER_JS;
    s.onload = cb;
    document.head.appendChild(s);
  }

  function run() {
    var r = document.getElementById('sl-spv-block-' + blockId);
    if (!r) return;
    var swiperEl = r.querySelector('.sl-spv-swiper');
    var slides = r.querySelectorAll('.sl-spv-card');
    if (!swiperEl || slides.length === 0) return;

    var autoplay = true;
    var isMuted = true;

    var swiperInstance = null;

    function playFocusedVideo() {
      if (!swiperInstance) return;
      var idx = swiperInstance.activeIndex;
      var activeSlide = swiperInstance.slides[idx];
      var focusedCard = activeSlide ? activeSlide.querySelector('.sl-spv-card') : null;
      var focusedVideo = focusedCard ? focusedCard.querySelector('video') : null;

      r.querySelectorAll('.sl-spv-card video').forEach(function(v) { if (v) v.pause(); });

      if (focusedVideo && autoplay) {
        ensureVideoSrc(focusedVideo);
        focusedVideo.muted = isMuted;
        var src = focusedVideo.src || focusedVideo.currentSrc || focusedVideo.getAttribute('data-src');
        var sourceEl = focusedVideo.querySelector('source');
        if (sourceEl && !src) src = sourceEl.src || sourceEl.getAttribute('src');
        if (src && !focusedVideo.src) focusedVideo.src = src;
        var hasSrc = focusedVideo.src || focusedVideo.currentSrc || (sourceEl && sourceEl.src);
        if (hasSrc) {
          var doPlay = function() {
            focusedVideo.muted = isMuted;
            if (!isMuted) focusedVideo.volume = 1;
            focusedVideo.play().catch(function(){});
          };
          if (focusedVideo.readyState >= 2) {
            doPlay();
          } else {
            focusedVideo.addEventListener('loadeddata', doPlay, { once: true });
            focusedVideo.addEventListener('canplay', doPlay, { once: true });
            focusedVideo.load();
          }
        }
      }
    }

    loadSwiper(function() {
      if (swiperEl.swiper) return;
      swiperInstance = new Swiper(swiperEl, {
        slidesPerView: 'auto',
        spaceBetween: 5,
        slidesOffsetAfter: 100,
        slidesOffsetBefore: 0,
        watchSlidesProgress: false,
        loop: false,
        navigation: {
          nextEl: r.querySelector('.swiper-button-next'),
          prevEl: r.querySelector('.swiper-button-prev')
        },
        on: {
          slideChange: function() { playFocusedVideo(); },
          init: function() {
            setTimeout(playFocusedVideo, 50);
          }
        }
      });

      slides.forEach(function(card) {
        card.addEventListener('click', function(e) {
          if (e.target.closest('.sl-spv-controls')) return;
          isMuted = !isMuted;
          r.querySelectorAll('.sl-spv-mute').forEach(function(b) { b.setAttribute('data-state', isMuted ? 'muted' : 'unmuted'); });
          var av = r.querySelector('.swiper-slide-active video');
          if (av) {
            av.muted = isMuted;
            if (!isMuted) av.volume = 1;
          }
        });
      });

      r.querySelectorAll('.sl-spv-mute').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          isMuted = !isMuted;
          r.querySelectorAll('.sl-spv-mute').forEach(function(b) { b.setAttribute('data-state', isMuted ? 'muted' : 'unmuted'); });
          var av = r.querySelector('.swiper-slide-active video');
          if (av) {
            av.muted = isMuted;
            if (!isMuted) av.volume = 1;
          }
        });
      });

    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();
</script>
{% elsif request.design_mode and prod != blank %}
  <div id="sl-spv-block-{{ block_id }}" class="sl-spv-block-root" style="padding: 12px; color: #666; border: 1px dashed #ccc;">
    <p style="margin: 0;">Social Proof Video â€” No videos. Add UGC Video entries to this product's <strong>Social proof videos</strong> metafield.</p>
  </div>
{% endif %}
